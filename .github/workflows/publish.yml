# Publish crates to crates.io
#
# Triggered manually or on tag push matching 'publish-v*'.
# Publishes crates in dependency order: ferrite-core first, then extensions.
#
# Prerequisites:
#   - CARGO_REGISTRY_TOKEN secret must be set in repo settings
#   - All crates must have valid metadata (description, license, readme)

name: Publish to crates.io

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (validate without publishing)'
        type: boolean
        default: true
      crate:
        description: 'Specific crate to publish (blank = all in order)'
        type: string
        default: ''

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Verify metadata
        run: |
          for crate in \
            ferrite-core \
            ferrite-search \
            ferrite-ai \
            ferrite-graph \
            ferrite-timeseries \
            ferrite-document \
            ferrite-streaming \
            ferrite-cloud \
            ferrite-k8s \
            ferrite-enterprise \
            ferrite-plugins \
            ferrite-studio; do
            echo "Checking $crate..."
            cargo publish --dry-run -p "$crate" 2>&1 | tail -3
          done

      - name: Publish crates (dependency order)
        if: ${{ !inputs.dry_run }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          CRATES=(
            ferrite-core
            ferrite-search
            ferrite-ai
            ferrite-graph
            ferrite-timeseries
            ferrite-document
            ferrite-streaming
            ferrite-cloud
            ferrite-k8s
            ferrite-enterprise
            ferrite-plugins
            ferrite-studio
          )

          # If a specific crate is requested, publish only that
          if [ -n "${{ inputs.crate }}" ]; then
            CRATES=("${{ inputs.crate }}")
          fi

          for crate in "${CRATES[@]}"; do
            echo "Publishing $crate..."
            cargo publish -p "$crate" --no-verify
            # Wait for crates.io index to update before publishing dependents
            echo "Waiting for index update..."
            sleep 30
          done
