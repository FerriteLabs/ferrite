# Ferrite Kubernetes CRD â€” FerriteCluster
#
# Apply with:
#   kubectl apply -f crates/ferrite-k8s/manifests/ferritecluster-crd.yaml
#
# Then create a cluster:
#   kubectl apply -f crates/ferrite-k8s/manifests/example-cluster.yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: ferriteclusters.ferrite.io
  labels:
    app.kubernetes.io/name: ferrite
    app.kubernetes.io/managed-by: ferrite-operator
spec:
  group: ferrite.io
  names:
    kind: FerriteCluster
    listKind: FerriteClusterList
    plural: ferriteclusters
    singular: ferritecluster
    shortNames:
      - fc
    categories:
      - ferrite
      - databases
  scope: Namespaced
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          description: A Ferrite database cluster
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - replicas
              properties:
                replicas:
                  type: integer
                  minimum: 1
                  maximum: 100
                  default: 3
                  description: Number of Ferrite nodes
                version:
                  type: string
                  default: "0.1.0"
                  description: Ferrite version to deploy
                image:
                  type: string
                  description: Custom container image (overrides version)
                imagePullPolicy:
                  type: string
                  enum: [Always, IfNotPresent, Never]
                  default: IfNotPresent
                resources:
                  type: object
                  properties:
                    limits:
                      type: object
                      properties:
                        cpu:
                          type: string
                          default: "2"
                        memory:
                          type: string
                          default: "4Gi"
                    requests:
                      type: object
                      properties:
                        cpu:
                          type: string
                          default: "500m"
                        memory:
                          type: string
                          default: "1Gi"
                persistence:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: true
                    storageClassName:
                      type: string
                    size:
                      type: string
                      default: "10Gi"
                    aofEnabled:
                      type: boolean
                      default: true
                    checkpointEnabled:
                      type: boolean
                      default: true
                tls:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                    secretName:
                      type: string
                      description: K8s Secret containing TLS cert and key
                auth:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                    passwordSecretName:
                      type: string
                      description: K8s Secret containing the default password
                cluster:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                    slotsPerNode:
                      type: integer
                      default: 5461
                metrics:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: true
                    port:
                      type: integer
                      default: 9090
                config:
                  type: object
                  description: Additional ferrite.toml configuration as key-value pairs
                  x-kubernetes-preserve-unknown-fields: true
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum: [Pending, Running, Failed, Terminating, Scaling]
                readyReplicas:
                  type: integer
                currentVersion:
                  type: string
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                        enum: ["True", "False", "Unknown"]
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
                endpoint:
                  type: string
                  description: Service endpoint for client connections
      subresources:
        status: {}
        scale:
          specReplicasPath: .spec.replicas
          statusReplicasPath: .status.readyReplicas
      additionalPrinterColumns:
        - name: Replicas
          type: integer
          jsonPath: .spec.replicas
        - name: Ready
          type: integer
          jsonPath: .status.readyReplicas
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Version
          type: string
          jsonPath: .spec.version
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
